# æ­¢æŸ/æ­¢ç›ˆè‡ªåŠ¨æœºåˆ¶è¯´æ˜Ž

## âœ… æ¦‚è¿°

**æ­¢æŸ/æ­¢ç›ˆæ˜¯å®Œå…¨è‡ªåŠ¨çš„**ï¼Œç³»ç»Ÿä¼šæ ¹æ®é¢„è®¾è§„åˆ™è‡ªåŠ¨è®¾ç½®ã€æ›´æ–°å’Œè§¦å‘ã€‚

---

## ðŸ“‹ æ­¢æŸè§„åˆ™

### 1. åˆå§‹æ­¢æŸï¼ˆPrimary Stop Lossï¼‰

- **ä»·æ ¼æ¥æº**ï¼š`primary_sl_price`ï¼ˆç”±ç­–ç•¥å±‚è®¡ç®—ï¼ŒåŸºäºŽç¬¬ä¸‰æžå€¼ï¼‰
- **è®¾ç½®æ—¶æœº**ï¼šå…¥åœºæ—¶è‡ªåŠ¨è®¾ç½®
- **è§¦å‘æ–¹å¼**ï¼šé€šè¿‡ Bybit äº¤æ˜“æ‰€çš„æ¡ä»¶å•è‡ªåŠ¨è§¦å‘

### 2. æ­¢æŸåŠ¨æ€æ›´æ–°è§„åˆ™

#### é˜¶æ®µ1ï¼šTP1 æˆäº¤å‰
- æ­¢æŸä»·æ ¼ = `primary_sl_price`ï¼ˆç¬¬ä¸‰æžå€¼ï¼‰
- å¦‚æžœä»·æ ¼è§¦åŠæ­¢æŸï¼Œå…¨éƒ¨ä»“ä½å¹³ä»“

#### é˜¶æ®µ2ï¼šTP1 æˆäº¤åŽï¼ˆè‡ªåŠ¨ä¿æœ¬ï¼‰
- **è‡ªåŠ¨æ“ä½œ**ï¼šæ­¢æŸä»·æ ¼è‡ªåŠ¨ä¸Šç§»åˆ° `entry_price`ï¼ˆå…¥åœºä»·ï¼‰
- **è§¦å‘æ¡ä»¶**ï¼šTP1 è®¢å•æˆäº¤åŽ
- **æ‰§è¡Œæ–¹å¼**ï¼š
  - LIVE æ¨¡å¼ï¼šé€šè¿‡ Bybit API `set_trading_stop` è‡ªåŠ¨æ›´æ–°
  - ç›‘æŽ§ï¼š`reconcile.py` æ¯ 5 ç§’æ£€æŸ¥ TP1 æˆäº¤çŠ¶æ€
  - WebSocketï¼šå®žæ—¶ç›‘æŽ§ TP1 è®¢å•çŠ¶æ€ï¼ˆå¦‚æžœå¯ç”¨ï¼‰

#### é˜¶æ®µ3ï¼šTP2 æˆäº¤åŽï¼ˆRunner è·Ÿéšæ­¢æŸï¼‰
- **è‡ªåŠ¨æ“ä½œ**ï¼šå¯ç”¨ Runner è·Ÿéšæ­¢æŸï¼ˆ`runner_stop_price`ï¼‰
- **è§¦å‘æ¡ä»¶**ï¼šTP2 è®¢å•æˆäº¤åŽ
- **æ›´æ–°é¢‘çŽ‡**ï¼šæ¯æ ¹ K çº¿æ”¶ç›˜æ—¶æ›´æ–°ï¼ˆ`lifecycle.py`ï¼‰
- **æ›´æ–°è§„åˆ™**ï¼šåªæ›´ä¸¥æ ¼ï¼Œä¸æ”¾æ¾ï¼ˆåªå‘ä¸Šç§»åŠ¨ï¼Œä¸å‘ä¸‹ï¼‰

---

## ðŸ“ˆ æ­¢ç›ˆè§„åˆ™

### ä»“ä½åˆ†é…

æ€»ä»“ä½æŒ‰ä»¥ä¸‹æ¯”ä¾‹åˆ†é…ï¼š
- **TP1**ï¼š40% ä»“ä½
- **TP2**ï¼š40% ä»“ä½
- **Runner**ï¼š20% ä»“ä½

### æ­¢ç›ˆä»·æ ¼è®¡ç®—

åŸºäºŽé£Žé™©å›žæŠ¥æ¯”ï¼ˆRï¼‰ï¼š
- **R = |entry_price - primary_sl_price|**ï¼ˆå…¥åœºä»·ä¸Žæ­¢æŸä»·çš„å·®å€¼ï¼‰

#### TP1ï¼ˆç¬¬ä¸€ç›®æ ‡ï¼‰
- **ä»·æ ¼**ï¼š`entry_price + R`ï¼ˆåšå¤šï¼‰æˆ– `entry_price - R`ï¼ˆåšç©ºï¼‰
- **é£Žé™©å›žæŠ¥æ¯”**ï¼š1:1
- **ä»“ä½**ï¼š40%

#### TP2ï¼ˆç¬¬äºŒç›®æ ‡ï¼‰
- **ä»·æ ¼**ï¼š`entry_price + 2R`ï¼ˆåšå¤šï¼‰æˆ– `entry_price - 2R`ï¼ˆåšç©ºï¼‰
- **é£Žé™©å›žæŠ¥æ¯”**ï¼š1:2
- **ä»“ä½**ï¼š40%

#### Runnerï¼ˆè·Ÿéšæ­¢æŸï¼‰
- **ä»“ä½**ï¼š20%
- **æ­¢æŸæ–¹å¼**ï¼šè·Ÿéšæ­¢æŸï¼ˆTrailing Stopï¼‰
- **æ­¢æŸæ¨¡å¼**ï¼šç”± `RUNNER_TRAIL_MODE` é…ç½®å†³å®š
  - `ATR`ï¼šåŸºäºŽ ATRï¼ˆå¹³å‡çœŸå®žæ³¢å¹…ï¼‰
  - `PIVOT`ï¼šåŸºäºŽ Pivot ç‚¹

---

## ðŸ”„ è‡ªåŠ¨è§¦å‘æœºåˆ¶

### LIVE æ¨¡å¼ï¼ˆå®žç›˜ï¼‰

1. **è®¢å•åˆ›å»º**ï¼š
   - å…¥åœºæ—¶è‡ªåŠ¨åˆ›å»º ENTRY è®¢å•ï¼ˆMarketï¼‰
   - åŒæ—¶åˆ›å»º TP1ã€TP2 æ¡ä»¶å•ï¼ˆLimitï¼Œreduce-onlyï¼‰
   - è®¾ç½®åˆå§‹æ­¢æŸï¼ˆé€šè¿‡ `set_trading_stop` APIï¼‰

2. **ç›‘æŽ§æœºåˆ¶**ï¼š
   - **WebSocket**ï¼ˆå¦‚æžœå¯ç”¨ï¼‰ï¼šå®žæ—¶ç›‘æŽ§è®¢å•çŠ¶æ€
   - **REST API è½®è¯¢**ï¼šæ¯ 5 ç§’æ£€æŸ¥ TP1/TP2 æˆäº¤çŠ¶æ€ï¼ˆ`reconcile.py`ï¼‰
   - **æŒä»“åŒæ­¥**ï¼šæ¯ 10 ç§’åŒæ­¥æŒä»“çŠ¶æ€ï¼ˆ`position_sync.py`ï¼‰

3. **è‡ªåŠ¨æ›´æ–°**ï¼š
   - TP1 æˆäº¤ â†’ è‡ªåŠ¨æ›´æ–°æ­¢æŸåˆ°ä¿æœ¬ä»·
   - TP2 æˆäº¤ â†’ å¯ç”¨ Runner è·Ÿéšæ­¢æŸ
   - æ¯æ ¹ K çº¿ â†’ æ›´æ–° Runner æ­¢æŸä»·æ ¼ï¼ˆåªæ›´ä¸¥æ ¼ï¼‰

### PAPER/BACKTEST æ¨¡å¼ï¼ˆæ¨¡æ‹Ÿï¼‰

1. **æ¨¡æ‹Ÿæ’®åˆ**ï¼š
   - `paper_sim.py` åœ¨æ¯æ ¹ K çº¿æ”¶ç›˜æ—¶æ¨¡æ‹Ÿæ’®åˆ
   - æ ¹æ® OHLC æ•°æ®åˆ¤æ–­æ˜¯å¦è§¦å‘ TP1/TP2/SL

2. **ä»·æ ¼è·¯å¾„å‡è®¾**ï¼š
   - å¦‚æžœ `close >= open`ï¼šä»·æ ¼è·¯å¾„ `open â†’ high â†’ low â†’ close`
   - å¦‚æžœ `close < open`ï¼šä»·æ ¼è·¯å¾„ `open â†’ low â†’ high â†’ close`

3. **è§¦å‘é¡ºåº**ï¼š
   - å…ˆæ£€æŸ¥æ­¢æŸï¼ˆä¿å®ˆï¼šåŒä¸€æ ¹ K åŒæ—¶ hit TP/SL æ—¶æŒ‰ SL å…ˆå‘ç”Ÿï¼‰
   - å†æ£€æŸ¥ TP1
   - æœ€åŽæ£€æŸ¥ TP2

---

## ðŸŽ¯ Runner è·Ÿéšæ­¢æŸè§„åˆ™

### ATR æ¨¡å¼ï¼ˆ`RUNNER_TRAIL_MODE=ATR`ï¼‰

- **è®¡ç®—å…¬å¼**ï¼š
  ```
  åšå¤šï¼šrunner_stop = close - (ATR * ATR_MULT)
  åšç©ºï¼šrunner_stop = close + (ATR * ATR_MULT)
  ```
- **å‚æ•°**ï¼š
  - `RUNNER_ATR_PERIOD`ï¼šATR å‘¨æœŸï¼ˆé»˜è®¤ 14ï¼‰
  - `RUNNER_ATR_MULT`ï¼šATR å€æ•°ï¼ˆé»˜è®¤ 2.0ï¼‰
- **æ›´æ–°è§„åˆ™**ï¼šåªæ›´ä¸¥æ ¼ï¼Œä¸æ”¾æ¾
  - åšå¤šï¼š`new_stop = max(current_stop, new_stop)`
  - åšç©ºï¼š`new_stop = min(current_stop, new_stop)`

### PIVOT æ¨¡å¼ï¼ˆ`RUNNER_TRAIL_MODE=PIVOT`ï¼‰

- **è®¡ç®—å…¬å¼**ï¼š
  ```
  åšå¤šï¼šrunner_stop = æœ€è¿‘çš„ pivot_low
  åšç©ºï¼šrunner_stop = æœ€è¿‘çš„ pivot_high
  ```
- **æ›´æ–°è§„åˆ™**ï¼šåªæ›´ä¸¥æ ¼ï¼Œä¸æ”¾æ¾

---

## ðŸ“Š ç›‘æŽ§å’Œæ—¥å¿—

### æ‰§è¡ŒæŠ¥å‘Šï¼ˆExecution Reportsï¼‰

ç³»ç»Ÿä¼šå‘å¸ƒä»¥ä¸‹æ‰§è¡ŒæŠ¥å‘Šï¼š
- `ENTRY_FILLED`ï¼šå…¥åœºè®¢å•æˆäº¤
- `TP1_FILLED`ï¼šTP1 è®¢å•æˆäº¤
- `TP2_FILLED`ï¼šTP2 è®¢å•æˆäº¤
- `SL_UPDATE`ï¼šæ­¢æŸæ›´æ–°ï¼ˆä¿æœ¬æˆ– Runnerï¼‰
- `PRIMARY_SL_HIT`ï¼šåˆå§‹æ­¢æŸè§¦å‘
- `EXIT_RULE_TRIGGERED`ï¼šæ¬¡æ—¥è§„åˆ™è§¦å‘

### æŸ¥çœ‹æ–¹å¼

```bash
# æŸ¥çœ‹æ‰§è¡ŒæŠ¥å‘Š
docker compose exec execution python -m scripts.trading_test_tool orders

# æŸ¥çœ‹æŒä»“çŠ¶æ€
docker compose exec execution python -m scripts.trading_test_tool positions --detailed

# æŸ¥çœ‹ Redis Streams ä¸­çš„æ‰§è¡ŒæŠ¥å‘Š
redis-cli XREVRANGE stream:execution_report + - COUNT 20
```

---

## âš™ï¸ é…ç½®å‚æ•°

### å…³é”®çŽ¯å¢ƒå˜é‡

```bash
# Runner è·Ÿéšæ­¢æŸæ¨¡å¼
RUNNER_TRAIL_MODE=ATR  # æˆ– PIVOT

# ATR å‚æ•°ï¼ˆå¦‚æžœä½¿ç”¨ ATR æ¨¡å¼ï¼‰
RUNNER_ATR_PERIOD=14
RUNNER_ATR_MULT=2.0

# å¯¹è´¦è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
RECONCILE_OPEN_ORDERS_POLL_INTERVAL_SEC=5

# WebSocket å¯ç”¨ï¼ˆå¯é€‰ï¼Œä½†æŽ¨èï¼‰
BYBIT_PRIVATE_WS_ENABLED=true
```

---

## ðŸ” ç¤ºä¾‹æµç¨‹

### å®Œæ•´äº¤æ˜“æµç¨‹ç¤ºä¾‹

1. **å…¥åœº**ï¼ˆä»·æ ¼ï¼š100 USDTï¼Œæ­¢æŸï¼š95 USDTï¼‰
   - åˆ›å»º ENTRY è®¢å•ï¼ˆMarketï¼‰
   - è®¾ç½®æ­¢æŸï¼š95 USDT
   - åˆ›å»º TP1 è®¢å•ï¼š105 USDTï¼ˆ40%ï¼‰
   - åˆ›å»º TP2 è®¢å•ï¼š110 USDTï¼ˆ40%ï¼‰
   - Runnerï¼š20%ï¼ˆè·Ÿéšæ­¢æŸï¼‰

2. **TP1 æˆäº¤**ï¼ˆä»·æ ¼è¾¾åˆ° 105 USDTï¼‰
   - 40% ä»“ä½å¹³ä»“
   - **è‡ªåŠ¨æ›´æ–°æ­¢æŸ**ï¼š95 USDT â†’ 100 USDTï¼ˆä¿æœ¬ï¼‰
   - å‰©ä½™ï¼š60% ä»“ä½ï¼ˆTP2 40% + Runner 20%ï¼‰

3. **TP2 æˆäº¤**ï¼ˆä»·æ ¼è¾¾åˆ° 110 USDTï¼‰
   - 40% ä»“ä½å¹³ä»“
   - **å¯ç”¨ Runner è·Ÿéšæ­¢æŸ**
   - å‰©ä½™ï¼š20% ä»“ä½ï¼ˆRunnerï¼‰

4. **Runner è·Ÿéšæ­¢æŸæ›´æ–°**ï¼ˆæ¯æ ¹ K çº¿ï¼‰
   - å¦‚æžœä½¿ç”¨ ATR æ¨¡å¼ï¼š`runner_stop = close - (ATR * 2.0)`
   - åªå‘ä¸Šç§»åŠ¨ï¼ˆæ›´ä¸¥æ ¼ï¼‰ï¼Œä¸å‘ä¸‹ç§»åŠ¨

5. **Runner æ­¢æŸè§¦å‘**
   - 20% ä»“ä½å¹³ä»“
   - äº¤æ˜“å®Œæˆ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ­¢æŸåªæ›´ä¸¥æ ¼**ï¼šRunner æ­¢æŸåªä¼šå‘ä¸Šç§»åŠ¨ï¼ˆåšå¤šï¼‰æˆ–å‘ä¸‹ç§»åŠ¨ï¼ˆåšç©ºï¼‰ï¼Œä¸ä¼šæ”¾æ¾
2. **TP1 ä¿æœ¬**ï¼šTP1 æˆäº¤åŽï¼Œæ­¢æŸè‡ªåŠ¨ä¸Šç§»åˆ°å…¥åœºä»·ï¼Œç¡®ä¿ä¸ä¼šäºæŸ
3. **è‡ªåŠ¨ç›‘æŽ§**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ç›‘æŽ§ TP1/TP2 æˆäº¤çŠ¶æ€ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
4. **å®žæ—¶æ›´æ–°**ï¼šRunner æ­¢æŸæ¯æ ¹ K çº¿æ›´æ–°ä¸€æ¬¡ï¼Œç¡®ä¿åŠæ—¶è·Ÿéšä»·æ ¼

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [SYNC_MECHANISM.md](./SYNC_MECHANISM.md) - è®¢å•ä¸ŽæŒä»“åŒæ­¥æœºåˆ¶
- [services/execution/README.md](./services/execution/README.md) - æ‰§è¡ŒæœåŠ¡è¯´æ˜Ž
- [COMPLETE_TESTING_GUIDE.md](./COMPLETE_TESTING_GUIDE.md) - å®Œæ•´æµ‹è¯•æŒ‡å—
